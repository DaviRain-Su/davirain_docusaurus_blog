# 交易生命周期

在 Substrate 中，交易包含要包含在块中的数据。由于事务中的数据源自运行时之外，因此事务有时更广泛地称为外部数据或外部数据。然而，最常见的外在因素是签名交易。因此，关于交易生命周期的讨论集中在如何验证和执行已签名的交易。

您已经了解到签名交易包括发送请求以执行某些运行时调用的帐户的签名。通常，使用提交请求的帐户的私钥对请求进行签名。在大多数情况下，提交请求的账户也会支付一笔交易费用。但是，交易费用和交易处理的其他元素取决于运行时逻辑的定义方式。

## 定义交易的地方
正如[运行时开发](https://docs.substrate.io/fundamentals/runtime-development/)中所讨论的，Substrate 运行时包含定义事务属性的业务逻辑，包括：
- 什么构成有效交易。
- 交易是作为签名还是未签名发送。
- 交易如何改变链的状态。
通常，您使用托盘来组合运行时函数并实现您希望您的链支持的事务。编译运行时后，用户与区块链交互以提交作为交易处理的请求。例如，用户可能会提交将资金从一个帐户转移到另一个帐户的请求。该请求成为包含该用户帐户签名的签名交易，如果用户帐户中有足够的资金来支付交易，则交易成功执行，并进行转账。

## 如何在块创作节点上处理交易
根据您的网络配置，您可能拥有被授权创作区块的节点和未被授权创作区块的节点的组合。如果一个 Substrate 节点被授权产生块，它可以处理它收到的签名和未签名的交易。下图说明了提交到网络并由创作节点处理的事务的生命周期。


![事务生命周期概述](./assets/transaction-lifecycle.avif)
任何发送到[非创作节点](https://docs.substrate.io/fundamentals/transaction-lifecycle/)的签名或未签名交易都会被传递到网络中的其他节点并进入他们的交易池，直到被创作节点接收。

## 验证和排队交易
正如[共识](https://docs.substrate.io/fundamentals/consensus/)中所讨论的，网络中的大多数节点必须就区块中的交易顺序达成一致，以就区块链的状态达成一致并继续安全地添加区块。为了达成共识，三分之二的节点必须就执行交易的顺序和由此产生的状态变化达成一致。为了准备达成共识，交易首先在交易池中的本地节点上进行验证和排队。

## 验证交易池中的交易
使用运行时中定义的规则，事务池检查每个事务的有效性。这些检查确保只有满足特定条件的有效交易才排队包含在一个块中。例如，事务池可能会执行以下检查以确定事务是否有效：

- 交易索引（也称为交易随机数）是否正确？
- 用于签署交易的账户是否有足够的资金支付相关费用？
- 用于签署交易的签名是否有效？

在初始有效性检查之后，交易池会定期检查池中现有的交易是否仍然有效。如果发现事务无效或已过期，则将其从池中删除。

交易池只处理交易的有效性和放置在交易队列中的有效交易的排序。有关验证机制如何工作的具体细节——包括处理费用、账户或签名——可以在该[validate_transaction](https://paritytech.github.io/substrate/master/sp_transaction_pool/runtime_api/trait.TaggedTransactionQueue.html#method.validate_transaction)方法中找到。

## 将有效事务添加到事务队列
如果事务被识别为有效，事务池将事务移动到事务队列中。有效交易有两个交易队列：

- 就绪队列包含可以包含在新待处理块中的事务。如果运行时是使用 FRAME 构建的，则事务必须遵循它们放置在就绪队列中的确切顺序。
- 未来队列包含将来可能变得有效的事务。例如，如果一个交易`nonce`的账户对其账户来说太高，它可以在未来队列中等待，直到该账户的适当数量的交易被包含在链中。

## 无效的事务处理

如果交易无效——例如，因为它太大或不包含有效签名——它会被拒绝并且不会被添加到块中。交易可能由于以下任何原因而被拒绝：

- 该事务已包含在一个块中，因此它已从验证队列中删除。
- 交易的签名无效，因此立即被拒绝。
- 交易太大而无法放入当前区块，因此将其放回队列中以进行新一轮验证。

## 按优先级排序的交易
如果节点是下一个区块作者，则该节点使用优先级系统对下一个区块的交易进行排序。交易从高优先级到低优先级排序，直到块达到最大权重或长度。

事务优先级在运行时计算，并作为事务上的标签提供给外部节点。在 FRAME 运行时，一个特殊的托盘用于根据与交易相关的权重和费用计算优先级。此优先级计算适用于所有类型的事务，但固有事务除外。`Inherents` 总是首先使用[EnsureInherentsAreFirsttrait](https://paritytech.github.io/substrate/master/frame_support/traits/trait.EnsureInherentsAreFirst.html) 放置。

### 基于账户的交易排序
如果您的运行时是使用 FRAME 构建的，则每个签名交易都包含一个随机数，每次特定帐户进行新交易时都会增加该随机数。例如，来自新帐户`nonce = 0`的第一笔交易为 ，同一帐户的第二笔交易为`nonce = 1`。区块创作节点可以在对交易进行排序以包含在区块中时使用随机数。

对于具有依赖关系的交易，排序会考虑交易支付的费用以及对其包含的其他交易的任何依赖关系。例如：

- 如果有一个未签名的交易`TransactionPriority::max_value()`和另一个签名的交易，则未签名的交易首先放入队列中。
- 如果有两个交易来自不同的发送者，则`priority`确定哪个交易更重要，应该首先包含在块中。
- 如果来自同一发送者的两笔交易具有相同的`nonce:` 只有一笔交易可以包含在块中，因此只有费用较高的交易会被包含在队列中。
### 执行交易并产生区块
在将有效交易放入交易队列后，一个单独的执行模块会协调如何执行交易以产生一个块。执行模块调用运行时模块中的函数并按特定顺序执行这些函数。

作为运行时开发人员，了解执行模块如何与系统托盘以及构成区块链业务逻辑的其他托盘交互非常重要，因为您可以插入执行模块的逻辑以作为以下操作的一部分执行：

- 初始化一个块
- 执行要包含在块中的事务
- 完成块构建

#### 初始化一个块
为了初始化一个块，执行模块首先调用`on_initialize`系统托盘中的函数，然后调用所有其他运行时托盘中的函数。该`on_initialize`功能使您能够定义应在执行事务之前完成的业务逻辑。系统托盘`on_initialize`功能总是首先执行。其余托盘按照它们在`construct_runtime!`宏中定义的顺序被调用。

执行完所有`on_initialize`功能后，执行模块检查区块头中的父哈希和树根，以验证信息是否正确。

#### 执行交易
区块初始化后，每笔有效交易都会按照交易优先级的顺序执行。重要的是要记住状态在执行之前不会被缓存。相反，状态更改在执行期间直接写入存储。如果交易在执行过程中失败，那么在失败之前发生的任何状态更改都不会被恢复，从而使块处于不可恢复的状态。在将任何状态更改提交到存储之前，运行时逻辑应执行所有必要的检查以确保外部操作成功。

请注意，[事件](https://docs.substrate.io/build/events-and-errors/)也会写入存储。因此，运行时逻辑不应在执行补充操作之前发出事件。如果在发出事件后事务失败，则不会恢复该事件。

#### 完成一个块
在所有排队的事务都已执行后，执行模块调用每个托盘`on_idle`和`on_finalize`函数以执行应在块末尾发生的任何最终业务逻辑。`construct_runtime!`模块按照宏中定义的顺序再次执行，但在这种情况下，`on_finalize`系统托盘中的功能最后执行。

在执行完所有`on_finalize`功能后，执行模块检查块头中的摘要和存储根是否与初始化块时计算的内容相匹配。

该`on_idle`函数还通过块的剩余权重，以允许根据区块链的使用情况执行。

## 阻止创作和阻止导入
到目前为止，您已经了解了事务是如何包含在本地节点生成的块中的。如果本地节点被授权出块，则交易生命周期遵循如下路径：

1. 本地节点侦听网络上的事务。
2. 每笔交易都经过验证。
3. 有效的交易被放置在交易池中。
4. 交易池在适当的交易队列中对有效交易进行排序，执行模块调用运行时开始下一个块。
5. 执行事务并将状态更改存储在本地内存中。
6. 构建的块发布到网络。

区块发布到网络后，可供其他节点导入。块导入队列是每个 Substrate 节点中外部节点的一部分。块导入队列侦听传入的块和与共识相关的消息，并将它们添加到池中。在池中，检查传入信息的有效性，如果无效则丢弃。在验证区块或消息有效后，区块导入队列将传入的信息导入本地节点的状态，并将其添加到节点知道的区块数据库中。

在大多数情况下，您不需要了解交易是如何被八卦的或网络上其他节点如何导入区块的详细信息。但是，如果您计划编写任何自定义共识逻辑或想了解更多关于块导入队列的实现，您可以在 `Rust API` 文档中找到详细信息。

- [ImportQueue](https://paritytech.github.io/substrate/master/sc_consensus/import_queue/trait.ImportQueue.html)
- [Link](https://paritytech.github.io/substrate/master/sc_consensus/import_queue/trait.Link.html)
- [BasicQueue](https://paritytech.github.io/substrate/master/sc_consensus/import_queue/struct.BasicQueue.html)
- [Verifier](https://paritytech.github.io/substrate/master/sc_consensus/import_queue/trait.Verifier.html)
- [BlockImport](https://paritytech.github.io/substrate/master/sc_consensus/block_import/trait.BlockImport.html)

## 下一步去哪里

- [研讨会：交易的生命周期](https://www.youtube.com/watch?v=3pfM0GOp02c)
- [帐户、地址和密钥](https://docs.substrate.io/fundamentals/accounts-addresses-keys/)

