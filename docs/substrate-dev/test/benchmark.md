# 基准

Substrate 和 FRAME 为您的区块链开发自定义逻辑提供了一个灵活的框架。这种灵活性使您能够设计复杂的交互式托盘并实现复杂的运行时逻辑。但是，确定分配给托盘功能的适当重量可能是一项艰巨的任务。基准测试使您能够测量在运行时和不同条件下执行不同功能所需的时间。如果您使用基准测试为函数调用分配准确的权重，则可以防止您的区块链过载而无法生成块或容易受到恶意行为者的拒绝服务 (DoS) 攻击。

为什么要对托盘进行基准测试
重要的是要了解执行不同功能所需的计算资源——包括运行时函数，如on_initialize和verify_unsigned——以保持运行时安全，并使运行时能够根据可用资源包含或排除事务。

基于可用资源包含或排除事务的能力确保运行时可以继续生成和导入块而不会中断服务。例如，如果您有一个需要特别密集计算的函数调用，则执行调用可能会超过生成或导入块所允许的最长时间，从而中断块处理过程或完全停止区块链进程。基准测试可帮助您验证不同功能所需的执行时间是否在合理范围内。

同样，恶意用户可能会尝试通过重复执行需要密集计算或不能准确反映所需计算的函数调用来中断网络服务。如果执行函数调用的成本不能准确反映所涉及的计算，则没有动力阻止恶意用户攻击网络。因为基准测试可以帮助您评估与执行交易相关的权重，它还可以帮助您确定适当的交易费用。根据您的基准，您可以设置代表在区块链上执行特定调用所消耗的资源的费用。

开发线性模型
在较高级别上，基准测试需要您执行以下步骤：

编写为函数执行特定代码路径的自定义基准测试逻辑。
在特定硬件集和特定运行时配置的 WebAssembly 执行环境中执行基准测试逻辑。
在可能影响函数所需执行时间的受控范围内执行基准测试逻辑。
对函数中的每个组件多次执行基准测试，以隔离和删除异常值。
根据执行基准逻辑生成的结果，基准测试工具在其所有组件中创建函数的线性模型。函数的线性模型使您能够估计执行特定代码路径所需的时间并做出明智的决策，而无需在运行时实际花费任何大量资源。基准测试假设所有事务都具有线性复杂度，因为更高复杂度的函数被认为对运行时是危险的，因为这些函数的权重可能会随着运行时状态或输入变得过于复杂而爆炸。

基准测试和权重
正如交易、权重和费用中所讨论的，基于 Substrate 的链使用权重的概念来表示在一个区块中执行交易所需的时间。在事务中执行任何特定调用所需的时间取决于几个因素，包括：

计算复杂度。
存储复杂性。
需要数据库读写操作。
使用的硬件。
要计算交易的适当权重，您可以使用基准参数来测量在不同硬件上执行函数调用所花费的时间，使用不同的变量值，并重复多次。然后，您可以使用基准测试的结果来建立近似的最坏情况权重，以表示执行每个函数调用和每个代码路径所需的资源。然后费用基于最坏情况的重量。如果实际调用的表现优于最差情况，则调整权重并退回任何超额费用。

因为权重是基于特定物理机器计算时间的通用度量单位，所以任何函数的权重都可以根据用于基准测试的特定硬件而改变。

通过对每个运行时函数的预期权重进行建模，区块链能够计算出它可以在一定时间内执行多少事务或系统级调用。

在 FRAME 中，可以分派的每个函数调用都必须有一个#[weight]注释，该注释可以在给定输入的情况下返回该函数在最坏情况下执行的预期权重。基准测试框架会自动为您生成包含这些公式的文件。

基准测试工具
基准测试框架提供的工具可帮助您为运行时中的函数添加、测试、运行和分析基准测试。可帮助您确定执行函数调用所需时间的基准测试工具包括：

基准宏可帮助您编写、测试和添加运行时基准。
用于处理基准数据的线性回归分析函数。
命令行界面 (CLI)，使您能够在节点上执行基准测试。
编译节点时默认禁用端到端基准测试管道。如果你想运行基准测试，你需要编译一个带有runtime-benchmarksRust 特性标志的节点。

编写基准
编写运行时基准测试类似于为您的托盘编写单元测试。与单元测试一样，基准测试必须在代码中执行特定的逻辑路径。在单元测试中，您检查代码以获取特定的成功和失败结果。对于基准测试，您希望执行计算量最大的路径。

在编写基准测试时，您应该考虑可能影响函数复杂性的特定条件（例如存储或运行时状态）。例如，如果在for循环中触发更多迭代会增加数据库读取和写入操作的数量，则应设置触发此条件的基准，以更准确地表示函数将如何执行。

如果一个函数根据用户输入或其他条件执行不同的代码路径，您可能不知道哪个路径的计算量最大。为了帮助您了解代码中的复杂性可能变得难以管理的地方，您应该为每个可能的执行路径创建一个基准。基准可以帮助您识别代码中您可能希望强制执行边界的位置（例如，通过限制向量中的元素数量或限制循环中的迭代次数）for来控制用户与您的托盘交互的方式。

您可以在所有预构建的FRAME 托盘中找到端到端基准测试的示例。

测试基准
您可以使用您为对托盘进行单元测试而创建的相同模拟运行时来测试基准。您在benchmarking.rs模块中使用的基准测试宏会自动为您生成测试函数。例如：
```
fn test_benchmark_[benchmark_name]<T>::() -> Result<(), &'static str>
```
您可以将基准函数添加到单元测试中，并确保函数的结果是Ok(()).

验证块
通常，您只需检查是否返回了基准测试，Ok(())因为该结果表明该函数已成功执行。但是，verify如果您想验证任何最终条件，例如运行时的最终状态，您可以选择在基准测试中包含一个块。附加verify块不会影响最终基准测试过程的结果。

使用基准运行单元测试
要运行基准测试，您需要指定要测试的包并启用该runtime-benchmarks功能。例如，您可以通过运行以下命令来测试 Balances 托盘的基准：
```
cargo test --package pallet-balances --features runtime-benchmarks
```
添加基准
每个托盘包含的基准不会自动添加到您的节点。要执行这些基准测试，您需要实现frame_benchmarking::Benchmarktrait。您可以在Substrate 节点中看到如何执行此操作的示例。

假设您的节点上已经设置了一些基准，您只需将托盘添加到define_benchmarks!宏中：
```
#[cfg(feature = "runtime-benchmarks")]
mod benches {
	define_benchmarks!(
		[frame_benchmarking, BaselineBench::<Runtime>]
		[pallet_assets, Assets]
		[pallet_babe, Babe]
    ...
    [pallet_mycustom, MyCustom]
    ...
```
runtime-benchmarks添加托盘后，使用功能标志编译节点二进制文件。例如：
```
cd bin/node/cli
cargo build --profile=production --features runtime-benchmarks
```
该production配置文件应用了各种编译器优化。
这些优化大大减慢了编译过程。
如果您只是在测试并且不需要最终数字，请使用--release命令行选项而不是production配置文件。

运行基准
在您编译了启用了基准的节点二进制文件后，您需要执行基准。如果您使用production配置文件编译节点，则可以通过运行以下命令列出可用的基准：
```
./target/production/node-template benchmark pallet --list
```
对所有托盘中的所有功能进行基准测试
要执行运行时的所有基准测试，您可以运行类似于以下的命令：
```
./target/production/node-template benchmark pallet \
    --chain dev \
    --execution=wasm \
    --wasm-execution=compiled \
    --pallet "*" \
    --extrinsic "*" \
    --steps 50 \
    --repeat 20 \
    --output pallets/all-weight.rs
```
此命令创建一个输出文件——在这种情况下，一个名为的文件——为你的运行时all-weight.rs实现WeightInfo特征。

对托盘中的特定功能进行基准测试
要在特定托盘中执行特定功能的基准测试，您可以运行类似于以下的命令：
```
./target/production/node-template benchmark pallet \
    --chain dev \
    --execution=wasm \
    --wasm-execution=compiled \
    --pallet pallet_balances \
    --extrinsic transfer \
    --steps 50 \
    --repeat 20 \
    --output pallets/transfer-weight.rs
```
此命令为选定的托盘创建一个输出文件，例如，transfer-weight.rs实现托盘的WeightInfo特征pallet_balances。

使用模板格式化基准
基准测试命令行界面使用 Handlebars 模板来格式化最终输出文件。您可以选择传递--template命令行选项来指定自定义模板而不是默认模板。在模板中，您可以访问TemplateData基准测试命令行界面中结构提供的所有数据。

输出生成中包含一些自定义 Handlebars 助手：

underscore: 为字符串右边的每 3 个字符添加一个下划线。主要用于分隔大数。
join: 将字符串数组加入到模板的空格分隔字符串中。主要用于连接所有传递给 CLI 的参数。
要获取子命令的完整列表benchmark，请运行：
```
./target/production/node-template benchmark --help
```
要获取benchmark pallet子命令的可用选项的完整列表，请运行：
```
./target/production/node-template benchmark pallet --help
```
下一步去哪里
框架基准测试自述文件
基板研讨会：对您的基板托盘进行基准测试
操作方法：添加基准
命令参考：node-template benchmark